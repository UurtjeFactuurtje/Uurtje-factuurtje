steps:
- bash: |
    cd Services
    cd $(projectPath)
    docker build \
        -t $(registryServerName)/$(imageName):$(imageTag) \
        .
  failOnStderr: true
  displayName: 'docker build'

- task: SonarCloudPrepare@1
  inputs:
    SonarCloud: 'CI Pipeline test'
    organization: 'uurtjefactuurtje'
    scannerMode: 'MSBuild'
    projectKey: 'roytimmers.visualstudio.com.sonarexamples.netfx'
    projectName: 'Hour Registration'
    
- task: SonarCloudPublish@1
  inputs:
    pollingTimeoutSec: '300'  

- task: SonarCloudAnalyze@1

- bash: |
    echo $(registryPassword) | docker login \
        $(registryServerName) \
        -u $(registryLogin) \
        --password-stdin
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
  displayName: 'docker login'
- bash: |
    # docker tag $(imageName) $(registryServerName)/$(imageName):$(imageTag)
    docker push $(registryServerName)/$(imageName):$(imageTag)
  failOnStderr: true
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
  displayName: 'docker push'
- task: HelmInstaller@1
  displayName: 'install helm'
  inputs:
    helmVersionToInstall: $(helmVersion)
- bash: |
    cd Services
    cd $(projectPath)
    helm package \
        --version $(helmChartVersion) \
        --app-version $(imageTag) \
        charts/$(projectName)
  failOnStderr: true
  displayName: 'helm package'
- bash: |
    cd Services
    cd $(projectPath)
    chartPackage=$(ls $(imageName)-*.tgz)
    az acr helm push \
        -n $(registryName) \
        -u $(registryLogin) \
        -p $(registryPassword) \
        $chartPackage
    echo $(jq -n --arg version "$(helmChartVersion)" '{helmChartVersion: $version}') > $(build.artifactStagingDirectory)/variables.json
  failOnStderr: true
  name: helmPush
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))
  displayName: 'az acr helm push'
- publish: $(build.artifactStagingDirectory)
  artifact: build-artifact
  condition: and(succeeded(), eq(variables['build.sourceBranch'], 'refs/heads/master'))